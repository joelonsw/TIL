### 2021-12-21

## DKIM ì ìš©í•˜ê¸°
- *ì°¸ê³ : https://hiseon.me/linux/ubuntu/dkim-settings/*
- *ì°¸ê³ : https://meetup.toast.com/posts/248*
- *ì°¸ê³ : https://www.cisco.com/c/ko_kr/support/docs/security/email-security-appliance/215360-best-practice-for-email-authentication.html*
- **DKIM ì´ë€?**
    - ë©”ì¼ ë°œì†¡ìì˜ ë„ë©”ì¸ê³¼ ë©”ì¼ì˜ ë¬´ê²°ì„±ì„ ê²€ì¦í•  ìˆ˜ ìˆëŠ” ê¸°ìˆ 
    - ë³´ë‚¸ì‚¬ëŒ ì£¼ì†Œê°€ ìœ„ì¡°ëœ ê²½ìš° ë©”ì¼ íƒì§€
    - Verbling DKIM signature
    ```
    DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=info.verbling.com; 
    h=content-type:from:mime-version:subject:reply-to:x-feedback-id:to; 
    s=s1; bh=yurMcrg5W97a0bnM840AyZYyEnx4j8QZcGCRwB4r6eM=; 
    b=qEiTpG63wwKCYlEPQ05DfLtq5OzIgvT5qgKwhqn0h6IN/3khkA7pfD5C33a9phS+MBTH 
    cGIUgYoeUBeFHB1xluq/zxi9D/qyxfznfl++2GsJY5FK6emKhrCPpuMBCrjFyspyuMfClZ 
    EFqT33dTpty4jKzhbe2YMJUfFKfP1AZ8ENQN/+GvjDufjguwBUJ0PhEZrH8NCnsheszPw9 
    gu9Sb5abx5WsCbvoUBJtDaXgwyLDpAwwgK6H6NgPw1Zt96a531KjM7053omFk2zu872lnG 
    uk74LtvEc5MUglVqbvHevFk74CUsxHUCaoTlKNq14UQCtVdZ3jT/R2NQwbQ3nZeg==
    ```
    - DKIM ê²€ì¦ íë¦„
        - ![](../images/2021-12-21-dkim-ê²€ì¦íë¦„.png)

- **OpenDKIM ì„¤ì¹˜**
    - `$ sudo apt-get install opendkim opendkim-tools`

- **DKIM ì´ë¡ **
    - ë°œì‹ ìê°€ ë°œì‹  ë©”ì‹œì§€ì— ì•”í˜¸ë¡œ ì„œëª…í•˜ê³ , ë‹¤ë¥¸ í™•ì¸ ë©”íƒ€ë°ì´í„°ì™€ í•¨ê»˜ DKIM-Signatureì— í¬í•¨ì‹œì¼œ ì „ì†¡
    - ë°œì‹ ìëŠ” DNSì— ê³µê°œí‚¤ë¥¼ ê²Œì‹œ
    - DKIMì„ êµ¬í˜„í•˜ê¸° ìœ„í•´ ì „ì†¡ì¡°ì§ì€ í•˜ë‚˜ì˜ ê³µê°œí‚¤ìŒì„ ìƒì„±í•˜ê³ , DNSì— ê³µê°œí‚¤ë¥¼ TXTë ˆì½”ë“œë¡œ ê²Œì‹œ
        - ê° í‚¤ìŒì€ "selector"ì—ì„œ ì°¸ì¡°
    - ë‹¤ìŒê³¼ ê°™ì´ ì„œëª…
        - a: ì„œëª…ì— ì‚¬ìš©ë  ì•Œê³ ë¦¬ì¦˜
        - c: ì •ê·œí™” ì²´ê³„ ì§€ì •
        - s: ì„ íƒí‚¤ ë˜ëŠ” í‚¤ ì°¸ì¡°
        - d: ì„œëª… ë„ë©”ì¸
        - h: ì„œëª…ëœ í—¤ë”ë¥¼ ë‚˜ì—´
        - i: ì„œëª… ì‚¬ìš©ì id
        ```
        DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=info.verbling.com;
        h=content-type:from:mime-version:subject:reply-to:x-feedback-id:to;
        s=s1; bh=yurMcrg5W97a0bnM840AyZYyEnx4j8QZcGCRwB4r6eM=;
        b=qEiTpG63wwKCYlEPQ05DfLtq5OzIgvT5qgKwhqn0h6IN/3khkA7pfD5C33a9phS+MBTH
        cGIUgYoeUBeFHB1xluq/zxi9D/qyxfznfl++2GsJY5FK6emKhrCPpuMBCrjFyspyuMfClZ
        EFqT33dTpty4jKzhbe2YMJUfFKfP1AZ8ENQN/+GvjDufjguwBUJ0PhEZrH8NCnsheszPw9
        gu9Sb5abx5WsCbvoUBJtDaXgwyLDpAwwgK6H6NgPw1Zt96a531KjM7053omFk2zu872lnG
        uk74LtvEc5MUglVqbvHevFk74CUsxHUCaoTlKNq14UQCtVdZ3jT/R2NQwbQ3nZeg==
        ```
    - DKIM ì„œëª… ë©”ì‹œì§€ë¥¼ ìˆ˜ì‹ í•˜ë©´ ë‹¤ìŒ DNS ì¿¼ë¦¬ë¥¼ êµ¬ì„±í•´ ê³µê°œí‚¤ ì¡°íšŒ
        - selector._domainkey.cstoday.me
        - ë²„ë¸”ë§ ì˜ˆì‹œ: s1._domainkey.info.verbling.com
        - ![](../images/2021-12-21-verbling-dkim.PNG)

- **ë“œë””ì–´ ì„±ê³µí•œ DKIM**
    - ìë°”ì—ì„œëŠ” pem ë§ê³  der ì–‘ì‹ì˜ ì¸ì¦ì„œë§Œ ì½ì„ ìˆ˜ ìˆìŒ
    - ë”°ë¼ì„œ íŒŒì¼ë¡œì¨ ì½ì€ ë‹¤ìŒì— ì¸ì¦ì— ì‚¬ìš©í•˜ë„ë¡ ì½”ë“œë¥¼ êµ¬í˜„
    - ìš”ëŸ° ê°¬ì„±
    ```java
    @Service
    public class MailSenderService {
    
        private static final String WELCOME_MAIL_SUBJECT = "ì˜¤ëŠ˜ì˜ CSë¥¼ êµ¬ë…í•´ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤ ğŸ";
        private static final String NEWSLETTER_SUBJECT = "ì˜¤ëŠ˜ì˜ CS ë‰´ìŠ¤ë ˆí„°ì…ë‹ˆë‹¤ ğŸ";
        private static final String SERVER_MAIL_NAME = "ì˜¤ëŠ˜ì˜ CS";
        private static final String SERVER_MAIL_ADDRESS = "cstoday@cstoday.me";
    
        private Mailer mailer;
        private File dkimFile;
    
        @Value("${setting.dkim}")
        private String dkimFilePath;
    
        @Value("${spring.mail.host}")
        private String mailHost;
    
        @Value("${spring.mail.port}")
        private Integer mailPort;
    
        @Value("${spring.mail.username}")
        private String mailUsername;
    
        @Value("${spring.mail.password}")
        private String mailPassword;
    
        @PostConstruct
        public void init() {
             mailer = MailerBuilder
                    .withSMTPServer(mailHost, mailPort, mailUsername, mailPassword)
                    .withTransportStrategy(TransportStrategy.SMTP_TLS)
                    .withProperty("mail.smtp.auth", true)
                    .withProperty("mail.smtp.timeout", 5000)
                    .withProperty("mail.smtp.socketFactory.class", "javax.net.ssl.SSLSocketFactory")
                    .withProperty("mail.smtp.starttls.enable", true)
                    .buildMailer();
    
             dkimFile = new File(dkimFilePath);
        }
    
        public void sendWelcomeMail(String destination) {
            final Email email = generateEmail(destination, WELCOME_MAIL_SUBJECT, WelcomeMail.welcomeMailContent);
            mailer.sendMail(email);
        }
    
        public void sendNewsLetter(String destination, String content) {
            final Email email = generateEmail(destination, NEWSLETTER_SUBJECT, content);
            mailer.sendMail(email);
        }
    
        private Email generateEmail(String destination, String subject, String content) {
            return EmailBuilder.startingBlank()
                    .to(destination)
                    .from(SERVER_MAIL_NAME, SERVER_MAIL_ADDRESS)
                    .withSubject(subject)
                    .withHTMLText(content)
                    .signWithDomainKey(dkimFile, "cstoday.me", "mail")
                    .buildEmail();
        }
    }
    ```